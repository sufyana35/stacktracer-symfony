services:
    _defaults:
        autowire: true
        autoconfigure: true
        public: false

    # HTTP Transport
    Stacktracer\SymfonyBundle\Transport\HttpTransport:
        arguments:
            $endpoint: '%stacktracer.transport.endpoint%'
            $apiKey: '%stacktracer.transport.api_key%'
            $logger: '@?logger'
            $batchSize: '%stacktracer.transport.batch_size%'
            $flushIntervalMs: '%stacktracer.transport.flush_interval_ms%'
            $maxQueueSize: '%stacktracer.transport.max_queue_size%'
            $timeout: '%stacktracer.transport.timeout%'
            $compress: '%stacktracer.transport.compress%'
            $maxRetries: '%stacktracer.transport.max_retries%'
        tags:
            - { name: kernel.reset, method: flush }

    Stacktracer\SymfonyBundle\Transport\TransportInterface:
        alias: Stacktracer\SymfonyBundle\Transport\HttpTransport

    # Main service
    Stacktracer\SymfonyBundle\Service\TracingService:
        arguments:
            $transport: '@Stacktracer\SymfonyBundle\Transport\TransportInterface'
            $enabled: '%stacktracer.enabled%'
            $spansEnabled: '%stacktracer.capture_spans%'
            $exceptionContextLines: '%stacktracer.exception_context_lines%'
            $stacktraceContextLines: '%stacktracer.stacktrace_context_lines%'
            $sampleRate: '%stacktracer.sample_rate%'
            $maxStackFrames: '%stacktracer.max_stack_frames%'
            $captureCodeContext: '%stacktracer.capture_code_context%'
            $filterVendorFrames: '%stacktracer.filter_vendor_frames%'
            $captureRequestHeaders: '%stacktracer.capture_request_headers%'
            $sensitiveKeys: '%stacktracer.sensitive_keys%'
            $serviceName: '%stacktracer.service_name%'
            $serviceVersion: '%stacktracer.service_version%'
        public: true
        tags:
            - { name: kernel.reset, method: flush }

    # Span Manager (for advanced span operations)
    Stacktracer\SymfonyBundle\Service\SpanManager:
        factory: ['@Stacktracer\SymfonyBundle\Service\TracingService', 'getSpanManager']
        public: true

    # Alias for easy injection
    stacktracer:
        alias: Stacktracer\SymfonyBundle\Service\TracingService
        public: true

    stacktracer.spans:
        alias: Stacktracer\SymfonyBundle\Service\SpanManager
        public: true

    # Monolog Handler
    # Event subscribers
    Stacktracer\SymfonyBundle\EventSubscriber\RequestTracingSubscriber:
        arguments:
            $tracing: '@Stacktracer\SymfonyBundle\Service\TracingService'
            $excludePatterns: '%stacktracer.exclude_patterns%'
        tags:
            - { name: kernel.event_subscriber }

    Stacktracer\SymfonyBundle\EventSubscriber\ExceptionTracingSubscriber:
        arguments:
            $tracing: '@Stacktracer\SymfonyBundle\Service\TracingService'
            $oomMemoryIncrease: '%stacktracer.oom_memory_increase%'
        tags:
            - { name: kernel.event_subscriber }

    # ============================================
    # Symfony Integrations (src/Integration/Symfony/)
    # ============================================

    # Console command tracing
    Stacktracer\SymfonyBundle\Integration\Symfony\ConsoleTracingSubscriber:
        arguments:
            $tracing: '@Stacktracer\SymfonyBundle\Service\TracingService'
            $oomMemoryIncrease: '%stacktracer.oom_memory_increase%'
        tags:
            - { name: kernel.event_subscriber }

    # Messenger tracing (async jobs/messages)
    Stacktracer\SymfonyBundle\Integration\Symfony\MessengerTracingSubscriber:
        arguments:
            $tracing: '@Stacktracer\SymfonyBundle\Service\TracingService'
        tags:
            - { name: kernel.event_subscriber }

    # Doctrine DBAL middleware (SQL queries)
    Stacktracer\SymfonyBundle\Integration\Symfony\DoctrineTracingMiddleware:
        arguments:
            $tracing: '@Stacktracer\SymfonyBundle\Service\TracingService'
            $slowQueryThreshold: '%stacktracer.integrations.doctrine.slow_query_threshold%'

    # HTTP Client decorator (outgoing requests)
    Stacktracer\SymfonyBundle\Integration\Symfony\TracingHttpClient:
        decorates: 'http_client'
        decoration_priority: 10
        arguments:
            $client: '@.inner'
            $tracing: '@Stacktracer\SymfonyBundle\Service\TracingService'
            $propagateContext: '%stacktracer.integrations.http_client.propagate_context%'

    # Form validation tracking
    Stacktracer\SymfonyBundle\Integration\Symfony\FormTracingSubscriber:
        arguments:
            $tracing: '@Stacktracer\SymfonyBundle\Service\TracingService'
        tags:
            - { name: kernel.event_subscriber }

    # Security event tracking (login, logout, access denied)
    Stacktracer\SymfonyBundle\Integration\Symfony\SecurityTracingSubscriber:
        arguments:
            $tracing: '@Stacktracer\SymfonyBundle\Service\TracingService'
        tags:
            - { name: kernel.event_subscriber }

    # Mailer tracking (email sending)
    Stacktracer\SymfonyBundle\Integration\Symfony\MailerTracingSubscriber:
        arguments:
            $tracing: '@Stacktracer\SymfonyBundle\Service\TracingService'
        tags:
            - { name: kernel.event_subscriber }

    # Twig error tracking
    Stacktracer\SymfonyBundle\Integration\Symfony\TwigTracingSubscriber:
        arguments:
            $tracing: '@Stacktracer\SymfonyBundle\Service\TracingService'
        tags:
            - { name: kernel.event_subscriber }

    # Twig template profiler extension
    Stacktracer\SymfonyBundle\Integration\Symfony\TwigTracingExtension:
        arguments:
            $tracing: '@Stacktracer\SymfonyBundle\Service\TracingService'
            $slowThreshold: '%stacktracer.integrations.twig.slow_threshold%'
        tags:
            - { name: twig.extension }

