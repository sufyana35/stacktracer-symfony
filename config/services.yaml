services:
    _defaults:
        autowire: true
        autoconfigure: true
        public: false

    # HTTP Transport
    Stacktracer\SymfonyBundle\Transport\HttpTransport:
        arguments:
            $endpoint: '%stacktracer.transport.endpoint%'
            $apiKey: '%stacktracer.transport.api_key%'
            $logger: '@?logger'
            $batchSize: '%stacktracer.transport.batch_size%'
            $flushIntervalMs: '%stacktracer.transport.flush_interval_ms%'
            $maxQueueSize: '%stacktracer.transport.max_queue_size%'
            $timeout: '%stacktracer.transport.timeout%'
            $compress: '%stacktracer.transport.compress%'
            $maxRetries: '%stacktracer.transport.max_retries%'
        tags:
            - { name: kernel.reset, method: flush }

    Stacktracer\SymfonyBundle\Transport\TransportInterface:
        alias: Stacktracer\SymfonyBundle\Transport\HttpTransport

    # Main service
    Stacktracer\SymfonyBundle\Service\TracingService:
        arguments:
            $transport: '@Stacktracer\SymfonyBundle\Transport\TransportInterface'
            $enabled: '%stacktracer.enabled%'
            $spansEnabled: '%stacktracer.capture_spans%'
            $exceptionContextLines: '%stacktracer.exception_context_lines%'
            $stacktraceContextLines: '%stacktracer.stacktrace_context_lines%'
            $sampleRate: '%stacktracer.sample_rate%'
            $maxStackFrames: '%stacktracer.max_stack_frames%'
            $captureCodeContext: '%stacktracer.capture_code_context%'
            $filterVendorFrames: '%stacktracer.filter_vendor_frames%'
            $captureRequestHeaders: '%stacktracer.capture_request_headers%'
            $sensitiveKeys: '%stacktracer.sensitive_keys%'
            $serviceName: '%stacktracer.service_name%'
            $serviceVersion: '%stacktracer.service_version%'
            $environment: '%stacktracer.environment%'
            $ignoredExceptions: '%stacktracer.ignored_exceptions%'
            $ignoredTransactions: '%stacktracer.ignored_transactions%'
        public: true
        tags:
            - { name: kernel.reset, method: flush }

    # Span Manager (for advanced span operations)
    Stacktracer\SymfonyBundle\Service\SpanManager:
        factory: ['@Stacktracer\SymfonyBundle\Service\TracingService', 'getSpanManager']
        public: true

    # Alias for easy injection
    stacktracer:
        alias: Stacktracer\SymfonyBundle\Service\TracingService
        public: true

    stacktracer.spans:
        alias: Stacktracer\SymfonyBundle\Service\SpanManager
        public: true

    # Monolog Handler
    # Event subscribers
    Stacktracer\SymfonyBundle\EventSubscriber\RequestTracingSubscriber:
        arguments:
            $tracing: '@Stacktracer\SymfonyBundle\Service\TracingService'
            $excludePatterns: '%stacktracer.exclude_patterns%'
        tags:
            - { name: kernel.event_subscriber }

    Stacktracer\SymfonyBundle\EventSubscriber\SubRequestTracingSubscriber:
        arguments:
            $tracing: '@Stacktracer\SymfonyBundle\Service\TracingService'
        tags:
            - { name: kernel.event_subscriber }

    Stacktracer\SymfonyBundle\EventSubscriber\ExceptionTracingSubscriber:
        arguments:
            $tracing: '@Stacktracer\SymfonyBundle\Service\TracingService'
            $oomMemoryIncrease: '%stacktracer.oom_memory_increase%'
        tags:
            - { name: kernel.event_subscriber }

    Stacktracer\SymfonyBundle\EventSubscriber\LoginListener:
        arguments:
            $tracing: '@Stacktracer\SymfonyBundle\Service\TracingService'
            $tokenStorage: '@?security.token_storage'
        tags:
            - { name: kernel.event_subscriber }

    # Controller tracing (optional - disabled by default)
    Stacktracer\SymfonyBundle\EventSubscriber\ControllerTracingSubscriber:
        arguments:
            $tracing: '@Stacktracer\SymfonyBundle\Service\TracingService'
            $enabled: '%stacktracer.integrations.controller.enabled%'
        tags:
            - { name: kernel.event_subscriber }

    # Metrics service
    Stacktracer\SymfonyBundle\Service\MetricsService:
        arguments:
            $tracing: '@Stacktracer\SymfonyBundle\Service\TracingService'
        public: true

    stacktracer.metrics:
        alias: Stacktracer\SymfonyBundle\Service\MetricsService
        public: true

    # ============================================
    # Symfony Component Integrations (src/Tracing/)
    # ============================================

    # Console command tracing
    Stacktracer\SymfonyBundle\EventSubscriber\ConsoleTracingSubscriber:
        arguments:
            $tracing: '@Stacktracer\SymfonyBundle\Service\TracingService'
            $oomMemoryIncrease: '%stacktracer.oom_memory_increase%'
            $excludedCommands: '%stacktracer.integrations.console.excluded_commands%'
        tags:
            - { name: kernel.event_subscriber }

    # Messenger tracing (async jobs/messages)
    Stacktracer\SymfonyBundle\Tracing\Messenger\MessengerSubscriber:
        arguments:
            $tracing: '@Stacktracer\SymfonyBundle\Service\TracingService'
            $captureSoftFails: '%stacktracer.integrations.messenger.capture_soft_fails%'
            $isolateScopeByMessage: '%stacktracer.integrations.messenger.isolate_scope_by_message%'
        tags:
            - { name: kernel.event_subscriber }

    # Doctrine DBAL middleware (SQL queries)
    Stacktracer\SymfonyBundle\Tracing\Doctrine\TracingMiddleware:
        arguments:
            $tracing: '@Stacktracer\SymfonyBundle\Service\TracingService'
            $slowQueryThreshold: '%stacktracer.integrations.doctrine.slow_query_threshold%'

    # HTTP Client decorator (outgoing requests)
    Stacktracer\SymfonyBundle\Tracing\HttpClient\TracingHttpClient:
        decorates: 'http_client'
        decoration_priority: 10
        arguments:
            $client: '@.inner'
            $tracing: '@Stacktracer\SymfonyBundle\Service\TracingService'
            $propagateContext: '%stacktracer.integrations.http_client.propagate_context%'

    # Form validation tracking
    Stacktracer\SymfonyBundle\Tracing\Form\FormSubscriber:
        arguments:
            $tracing: '@Stacktracer\SymfonyBundle\Service\TracingService'
        tags:
            - { name: kernel.event_subscriber }

    # Security event tracking (login, logout, access denied)
    Stacktracer\SymfonyBundle\Tracing\Security\SecuritySubscriber:
        arguments:
            $tracing: '@Stacktracer\SymfonyBundle\Service\TracingService'
        tags:
            - { name: kernel.event_subscriber }

    # Mailer tracking (email sending)
    Stacktracer\SymfonyBundle\Tracing\Mailer\MailerSubscriber:
        arguments:
            $tracing: '@Stacktracer\SymfonyBundle\Service\TracingService'
        tags:
            - { name: kernel.event_subscriber }

    # Twig error tracking
    Stacktracer\SymfonyBundle\Tracing\Twig\TwigSubscriber:
        arguments:
            $tracing: '@Stacktracer\SymfonyBundle\Service\TracingService'
        tags:
            - { name: kernel.event_subscriber }

    # Twig template tracing extension (provides twig functions)
    Stacktracer\SymfonyBundle\Tracing\Twig\TracingExtension:
        arguments:
            $tracing: '@Stacktracer\SymfonyBundle\Service\TracingService'
        tags:
            - { name: twig.extension }

    # Twig profiler subscriber (hooks into Twig's ProfilerExtension)
    Stacktracer\SymfonyBundle\Tracing\Twig\ProfilerSubscriber:
        arguments:
            $tracing: '@Stacktracer\SymfonyBundle\Service\TracingService'
            $twig: '@?twig'
            $slowThreshold: '%stacktracer.integrations.twig.slow_threshold%'
        tags:
            - { name: kernel.event_subscriber }
